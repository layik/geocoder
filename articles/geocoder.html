<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introducing geocoder • geocoder</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introducing geocoder">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geocoder</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/geocoder.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/geocoder-paper.html">geocoder: an R package to store and access geographic data in MongoDB</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/layik/geocoder">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introducing geocoder</h1>
                        <h4 class="author">L Hama</h4>
            
            <h4 class="date">2020-02-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/layik/geocoder/blob/master/vignettes/geocoder.Rmd"><code>vignettes/geocoder.Rmd</code></a></small>
      <div class="hidden name"><code>geocoder.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><code>geocoder</code> R package aims at managing large amounts of geocodes easier. Instead of loading geocodes from storage formats like shape, geojson etc, it is easier for data analysts to have access to their own offline/remote database of geocodes.</p>
</div>
<div id="uk-geocodes-case" class="section level2">
<h2 class="hasAnchor">
<a href="#uk-geocodes-case" class="anchor"></a>UK geocodes case</h2>
<p>UK Office of National Statistics Open Geography Portal contains various files which are used by data scientists to plot data on maps. Details of different layers etc.</p>
<div id="round-trip-through-mongodb" class="section level3">
<h3 class="hasAnchor">
<a href="#round-trip-through-mongodb" class="anchor"></a>Round trip through MongoDB</h3>
<p>To showcasee the capabilities of <code>geocoder</code> package, we can do a round trip data processing from a seudo-standard R spatial <code>sf</code> class back to itself through MongoDB’s geospatial querying. That is:</p>
<ul>
<li><p>take a shapefile from UK’s Open Geography Portal</p></li>
<li><p>turn it into an <code>sf</code> object</p></li>
<li><p>write it into a MongoDB collection and create a spatial index on it.</p></li>
<li><p>reassemble the output from find queries back to an <code>sf</code> object.</p></li>
</ul>
<p>One of the UK census boundaries is called Middle Superr Output Area (MSOA), which can be found <a href="https://opendata.arcgis.com/datasets/f341dcfd94284d58aba0a84daf2199e9_0.zip">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">msoa.folder =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"msoa_folder"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">msoa.zip =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"msoa.zip"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(msoa.file)) {</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://opendata.arcgis.com/datasets/"</span>,</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">           <span class="st">"f341dcfd94284d58aba0a84daf2199e9_0.zip"</span>),</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    msoa.zip)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span>(msoa.zip, <span class="dt">exdir =</span> msoa.folder)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># read the shape file using `sf`</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">msoa.sf =<span class="st"> </span>sf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_read.html">read_sf</a></span>(</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  <span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(msoa.folder, <span class="dt">pattern =</span> <span class="st">"England_and_Wales.shp"</span>))</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(msoa.sf)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co"># substring(geojsonsf::sf_geojson(msoa.sf[1,]), 1, 350)</span></a></code></pre></div>
<p>The data is ready in a clean <code>sf</code> object and we can convert each row into a ready to be used by <code>geocder</code> to import into Mongodb:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">geocoder<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geocoder/man/gc_import_sf.html">gc_import_sf</a></span>(msoa.sf, <span class="dt">collection =</span> <span class="st">"msoa"</span>)</a></code></pre></div>
<p>We can now query the database with lists of MSOA codes and easily return GeoJSON formatted “features” ready to be reassembled into <code>sf</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">r =<span class="st"> </span><span class="kw"><a href="../reference/gc_find.html">gc_find</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">properties.msoa01cd=</span><span class="st">"E02000998"</span>), <span class="dt">collection =</span> <span class="st">"msoa"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(r)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># [1] "data.frame"</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(r, <span class="dv">1</span>, <span class="dv">200</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># [1] "Feature"</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co"># [2] "list(objectid = 998, msoa01cd = \"E02000998\", ..."</span></a></code></pre></div>
</div>
<div id="find-geocodes-with-spatial-reference" class="section level3">
<h3 class="hasAnchor">
<a href="#find-geocodes-with-spatial-reference" class="anchor"></a>Find geocodes with spatial reference</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># head(st_coordinates(st_geometry(msoa.sf[1,])))</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># code for point -0.09640594 51.52283</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">qry &lt;-<span class="st"> '[</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="st">  {</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="st">    "$geoNear" : { </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="st">      "near" : { "type" : "Point", "coordinates" : [ -0.09640594, 51.52283 ] },</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="st">      "distanceField" : "dist.calculated",</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="st">      "maxDistance" : 1,</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="st">      "spherical" : true</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="st">    }</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="st">  }</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="st">] '</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">r =<span class="st"> </span>msoa.collection<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="dt">pipeline =</span> qry)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">r<span class="op">$</span>properties<span class="op">$</span>msoa01cd</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co"># "E02000001" "E02000576"</span></a></code></pre></div>
<p>The returned values are two different geometries which both correctly include the poin in the query.</p>
</div>
</div>
<div id="reproducible-example" class="section level2">
<h2 class="hasAnchor">
<a href="#reproducible-example" class="anchor"></a>Reproducible example</h2>
<p>A reproducible (as the UK msoa example is too large) for this Rmarkdown document would be a slice of Uber’s Vancouver land area price.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># geojson file from Uber</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sf)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; Linking to GEOS 3.7.1, GDAL 2.2.2, PROJ 4.9.2</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">v.path =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"vancouver.json"</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(v.path)) {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  v.url =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://github.com/layik/geocoder/releases/"</span>,</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">                 <span class="st">"download/data/v10.geojson"</span>)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(v.url, v.path)</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">v =<span class="st"> </span>geojsonsf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span>(v.path)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">vancouver =<span class="st"> </span>mongolite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span>(<span class="st">"vancouver"</span>)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co"># plot(v[8, ], axes = TRUE)</span></a></code></pre></div>
<p>Let us retrieve the data and plot the land:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">vancouver<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>() <span class="co"># if exists</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">geocoder<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geocoder/man/gc_import_sf.html">gc_import_sf</a></span>(v, <span class="dt">collection =</span> <span class="st">"vancouver"</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; Writing '10' documents...</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; Registered S3 method overwritten by 'jsonify':</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt;   method     from    </span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt;   print.json jsonlite</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; There are '10' documents in collection: vancouver</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">r =<span class="st"> </span>vancouver<span class="op">$</span><span class="kw">iterate</span>(<span class="dt">query =</span> <span class="st">'{"properties.growth":0.2781}'</span>)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">r.sf =<span class="st"> </span>geojsonsf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span>(r<span class="op">$</span><span class="kw">json</span>())</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co"># plot(r.sf[, ], axes = TRUE)</span></a></code></pre></div>
<p>Visual check that both entries are the same:</p>
<p><img src="geocoder_files/figure-html/unnamed-chunk-3-1.png" width="48%"><img src="geocoder_files/figure-html/unnamed-chunk-3-2.png" width="48%"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#uk-geocodes-case">UK geocodes case</a></li>
      <li><a href="#reproducible-example">Reproducible example</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by L Hama.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
