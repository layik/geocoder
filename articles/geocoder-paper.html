<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>geocoder: an R package to store and access geographic data in MongoDB • geocoder</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="geocoder: an R package to store and access geographic data in MongoDB">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geocoder</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/geocoder.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/geocoder-paper.html">geocoder: an R package to store and access geographic data in MongoDB</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/layik/geocoder">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>geocoder: an R package to store and access geographic data in MongoDB</h1>
                        <h4 class="author">L Hama</h4>
            
            <h4 class="date">2020-02-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/layik/geocoder/blob/master/vignettes/geocoder-paper.Rmd"><code>vignettes/geocoder-paper.Rmd</code></a></small>
      <div class="hidden name"><code>geocoder-paper.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Geocodes <span class="citation">(Goldberg, Wilson, and Knoblock 2007)</span> are spatial references which are used to identify points or boundaries in a geographic coordinate system. Finding geocodes is a cumbersome and repeated task for data scientists. In the case of the United Kingdom, despite the availability of “open geography portal” <span class="citation">(National Statistics 2016)</span>, data scientists need to locate the relevant source, which could be typically an ESRI shape or sometimes a comma separated values (CSV) file. In the case of those who use R as a data science tool, this also means processing these files repeatedly. Having these geocodes handy which can be easily accessed is what geospatial database management systems (DBMS) such as PostGIS and MongoDB should be doing. The idea of having an R package that can fascilitate this is the reason for a missing R package called <code>geocoder</code>. In the age of availability of wide range of SQL/NoSQL and other big data oriented DBMS’es, finding geocodes should be easier.</p>
</div>
<div id="motivation" class="section level2">
<h2 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h2>
<p>The Turing Institute’s <a href="https://www.turing.ac.uk/research/research-projects/turing-geovisualization-engine">eAtlas</a> project <span class="citation">(“Turing Geovisualization Engine” 2019)</span> is focused on visualizing spatially referenced datasets. It would be much easier to get the geographic data from datasets using databases rather than data science workflows in R/Python. Whilst developing a web based geovisualization eAtlas and allowing users to “load” their datasets in different formats, it would be great to detect geocodes and find coordinate data (such as longitute and latitudes) “automatically”. As it stands, there is no such open API (Application Programming Interface) to query for such geographic data and availability of such data locally (to the application) is becoming a need.</p>
</div>
<div id="relevant-technology" class="section level2">
<h2 class="hasAnchor">
<a href="#relevant-technology" class="anchor"></a>Relevant technology</h2>
<p>The standardisation of storage and access model of two-dimentional geographic references by both Open Geospatial Consortium (OGC) and International Organization for Standardisation (ISO) means programmers can define objects which represent these standards. This standard is known as <a href="https://www.iso.org/standard/40114.html">Simple Features</a>. In the case of R, the well known package called <code>sf</code> <span class="citation">(Pebesma 2018)</span> defines the standard and provides tools to manage geographic data in R. MongoDB is one of the DBMS’es which also support this standard.</p>
<p>MongoDB comes with built-in geospatial indexing and querying <span class="citation">(Ameri et al. 2014)</span> around GeoJSON <span class="citation">(Butler et al. 2016)</span>, which is another standard built on top of Simple Featurers. MongoDB accepts GeoJSON formatted coordinates, and database indices can be created which fascilitate fast spatial queries. As a data interchange format, GeoJSON is also widely supported by mapping libraries <span class="citation">(Page 2015)</span>. GeoJSON is JSON which is natively supported (read) by JavaScript and might be the reason for its wider popularity.</p>
</div>
<div id="uk-geocodes-case" class="section level2">
<h2 class="hasAnchor">
<a href="#uk-geocodes-case" class="anchor"></a>UK geocodes case</h2>
<p>UK Office of National Statistics Open Geography Portal contains various files which are used by data scientists to plot data on maps. Details of different layers etc.</p>
<div id="round-trip-through-mongodb" class="section level3">
<h3 class="hasAnchor">
<a href="#round-trip-through-mongodb" class="anchor"></a>Round trip through MongoDB</h3>
<p>To showcasee the capabilities of <code>geocoder</code> package, we can do a round trip data processing from a seudo-standard R spatial <code>sf</code> class back to itself through MongoDB’s geospatial querying. That is:</p>
<ul>
<li><p>take a shapefile from UK’s Open Geography Portal</p></li>
<li><p>turn it into an <code>sf</code> object</p></li>
<li><p>write it into a MongoDB collection and create a spatial index on it.</p></li>
<li><p>reassemble the output from find queries back to an <code>sf</code> object.</p></li>
</ul>
<p>One of the UK census boundaries is called Middle Superr Output Area (MSOA), which can be found <a href="https://opendata.arcgis.com/datasets/f341dcfd94284d58aba0a84daf2199e9_0.zip">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">msoa.folder =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"msoa_folder"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">msoa.zip =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"msoa.zip"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(msoa.file)) {</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://opendata.arcgis.com/datasets/"</span>,</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">           <span class="st">"f341dcfd94284d58aba0a84daf2199e9_0.zip"</span>),</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    msoa.zip)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span>(msoa.zip, <span class="dt">exdir =</span> msoa.folder)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># read the shape file using `sf`</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">msoa.sf =<span class="st"> </span>sf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_read.html">read_sf</a></span>(</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  <span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(msoa.folder, <span class="dt">pattern =</span> <span class="st">"England_and_Wales.shp"</span>))</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(msoa.sf)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co"># substring(geojsonsf::sf_geojson(msoa.sf[1,]), 1, 350)</span></a></code></pre></div>
<p>The data is ready in a clean <code>sf</code> object and we can convert each row into a ready to be used by <code>geocder</code> to import into Mongodb:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">geocoder<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geocoder/man/gc_import_sf.html">gc_import_sf</a></span>(msoa.sf, <span class="dt">collection =</span> <span class="st">"msoa"</span>)</a></code></pre></div>
<p>We can now query the database with lists of MSOA codes and easily return GeoJSON formatted “features” ready to be reassembled into <code>sf</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">r =<span class="st"> </span><span class="kw"><a href="../reference/gc_find.html">gc_find</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">properties.msoa01cd=</span><span class="st">"E02000998"</span>), <span class="dt">collection =</span> <span class="st">"msoa"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(r)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># [1] "data.frame"</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(r, <span class="dv">1</span>, <span class="dv">200</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># [1] "Feature"</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co"># [2] "list(objectid = 998, msoa01cd = \"E02000998\", ..."</span></a></code></pre></div>
</div>
<div id="find-geocodes-with-spatial-reference" class="section level3">
<h3 class="hasAnchor">
<a href="#find-geocodes-with-spatial-reference" class="anchor"></a>Find geocodes with spatial reference</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># head(st_coordinates(st_geometry(msoa.sf[1,])))</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># code for point -0.09640594 51.52283</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">qry &lt;-<span class="st"> '[</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="st">  {</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="st">    "$geoNear" : { </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="st">      "near" : { "type" : "Point", "coordinates" : [ -0.09640594, 51.52283 ] },</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="st">      "distanceField" : "dist.calculated",</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="st">      "maxDistance" : 1,</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="st">      "spherical" : true</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="st">    }</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="st">  }</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="st">] '</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">r =<span class="st"> </span>msoa.collection<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span>(<span class="dt">pipeline =</span> qry)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">r<span class="op">$</span>properties<span class="op">$</span>msoa01cd</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co"># "E02000001" "E02000576"</span></a></code></pre></div>
<p>The returned values are two different geometries which both correctly include the poin in the query.</p>
</div>
</div>
<div id="reproducible-example" class="section level2">
<h2 class="hasAnchor">
<a href="#reproducible-example" class="anchor"></a>Reproducible example</h2>
<p>A reproducible (as the UK msoa example is too large) for this manuscrript would be a slice of Uber’s Vancouver land area price.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># geojson file from Uber</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sf)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; Linking to GEOS 3.7.1, GDAL 2.2.2, PROJ 4.9.2</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">v.path =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"vancouver.json"</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(v.path)) {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  v.url =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://github.com/layik/geocoder/releases/"</span>,</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">                 <span class="st">"download/data/v10.geojson"</span>)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(v.url, v.path)</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">v =<span class="st"> </span>geojsonsf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span>(v.path)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">vancouver =<span class="st"> </span>mongolite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span>(<span class="st">"vancouver"</span>)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co"># plot(v[8, ], axes = TRUE)</span></a></code></pre></div>
<p>Let us retrieve the data and plot the land:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">vancouver<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>() <span class="co"># if exists</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">geocoder<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geocoder/man/gc_import_sf.html">gc_import_sf</a></span>(v, <span class="dt">collection =</span> <span class="st">"vancouver"</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; Writing '10' documents...</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; Registered S3 method overwritten by 'jsonify':</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt;   method     from    </span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt;   print.json jsonlite</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; There are '10' documents in collection: vancouver</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">r =<span class="st"> </span>vancouver<span class="op">$</span><span class="kw">iterate</span>(<span class="dt">query =</span> <span class="st">'{"properties.growth":0.2781}'</span>)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">r.sf =<span class="st"> </span>geojsonsf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geojsonsf/man/geojson_sf.html">geojson_sf</a></span>(r<span class="op">$</span><span class="kw">json</span>())</a></code></pre></div>
<p>Visual check that both entries are the same:</p>
<div class="figure">
<img src="geocoder-paper_files/figure-html/unnamed-chunk-3-1.png" alt="A sample from dataset plotted from MongoDB (left) and memory (right)" width="48%"><img src="geocoder-paper_files/figure-html/unnamed-chunk-3-2.png" alt="A sample from dataset plotted from MongoDB (left) and memory (right)" width="48%"><p class="caption">
A sample from dataset plotted from MongoDB (left) and memory (right)
</p>
</div>
</div>
<div id="r-vs-mongodb" class="section level2">
<h2 class="hasAnchor">
<a href="#r-vs-mongodb" class="anchor"></a>R vs Mongodb</h2>
<p>We can look at a use-casee where instead of searching through geocodes in memory we query a local database. For example, instead of loadinig one ore more files and converting them into <code>sf</code> or similar like objecsts in R, we search an spatial index in a MongoDB instance. Lets assume you have loaded the Vancouver real estate dataset into R and the same dataset has been imported using into MongoDB using <code><a href="../reference/gc_import_sf.html">geocoder::gc_import_sf()</a></code> function.</p>
<p>First we can make sure that a simple query returns the same number of rows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">v<span class="op">$</span><span class="kw">count</span>(<span class="st">'{"properties.growth": 0.2724}'</span>) <span class="op">==</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(sf<span class="op">$</span>growth <span class="op">==</span><span class="st"> </span><span class="fl">0.2724</span>))</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co"># [1] TRUE</span></a></code></pre></div>
<p>It is also fair to assume that for a data scientist to make a spatiial query, we have to load the dataset into memory first. We know that in-memory databases are built to manage in-memory access to data, but that is not the focus at the moment.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">url =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"https://github.com/uber-common/deck.gl-data/"</span>,</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">             <span class="st">"blob/master/examples/geojson/vancouver-blocks.json?raw=true"</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">v.path =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"v.geojson"</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(v.path)) {</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="kw"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(url, <span class="dt">destfile =</span> v.path)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co"># sampling the data</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">sf =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_read.html">st_read</a></span>(v.path)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">cent =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/geos_unary.html">st_centroid</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_as_sfc.html">st_as_sfc</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_bbox.html">st_bbox</a></span>(sf)))</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">cent =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_transform.html">st_transform</a></span>(cent, <span class="dv">3488</span>)</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">circle =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/geos_unary.html">st_buffer</a></span>(cent, <span class="dt">dist =</span> <span class="dv">3000</span>)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">circle =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_transform.html">st_transform</a></span>(circle, <span class="dv">4326</span>)</a></code></pre></div>
<p>The dataset is land boundaries in Vancouver with two variables: value per square meter and growth rate. We will use a sample of it by drawing a circle in the center of the boundary box of the whole dataset:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/sf/man/plot.html">plot</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_geometry.html">st_geometry</a></span>(sf))</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/pkg/sf/man/plot.html">plot</a></span>(circle, <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">add =</span> T)</a></code></pre></div>
<div class="figure" style="text-align: center">
<img src="geocoder-paper_files/figure-html/dataset-1.png" alt="Vancouver real estate dataset and sample area." width="60%"><p class="caption">
Vancouver real estate dataset and sample area.
</p>
</div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># import sf into Mongodb</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">v =<span class="st"> </span>mongolite<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/mongolite/man/mongo.html">mongo</a></span>(<span class="dt">collection =</span> <span class="st">"test_geocoder"</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">v<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/drop.html">drop</a></span>() <span class="co"># just in case</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">geocoder<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geocoder/man/gc_import_sf.html">gc_import_sf</a></span>(sf, <span class="dt">collection =</span> <span class="st">"test_geocoder"</span>)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co"># scoping</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">sffind =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">vfind =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co"># load and search</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">sf_search =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  sf =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_read.html">st_read</a></span>(v.path)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  <span class="co"># in memory search (R)</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">  sffind &lt;&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/geos_binary_ops.html">st_intersection</a></span>(sf, <span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_as_sf.html">st_as_sf</a></span>(circle))</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb10-15" data-line-number="15"></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co"># Mongo search</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">mongo_search =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">  vfind &lt;&lt;-<span class="st"> </span>v<span class="op">$</span><span class="kw">iterate</span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'{</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="st">     "geometry": { </span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="st">        "$geoIntersects": {</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="st">            "$geometry": '</span>, </a>
<a class="sourceLine" id="cb10-22" data-line-number="22">             geojsonsf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/geojsonsf/man/sf_geojson.html">sf_geojson</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_as_sf.html">st_as_sf</a></span>(circle), <span class="dt">atomise =</span> <span class="ot">TRUE</span> )</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">          ,<span class="st">'</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="st">        }</span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="st">      }</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="st">     }'</span>))</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb10-28" data-line-number="28">mb =<span class="st"> </span>microbenchmark<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">  <span class="kw">sf_search</span>(),</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">  <span class="kw">mongo_search</span>(),</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">  <span class="dt">times =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32">)</a></code></pre></div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>Looking at the results, which understandably varies considerably between the two methods because in the case of searching in memory, although it is faster, we need to load the whole data (1.5mb) into memory first. To paint the whole picture, under the same circumstances, even if the whole data is queried, searching through MongoDB would only be three times slower.</p>
<pre><code>#&gt; Unit: milliseconds
#&gt;            expr       min        lq      mean    median        uq       max
#&gt;     sf_search() 304.27367 304.27367 304.27367 304.27367 304.27367 304.27367
#&gt;  mongo_search()   1.12441   1.12441   1.12441   1.12441   1.12441   1.12441
#&gt;  neval
#&gt;      1
#&gt;      1</code></pre>
<p>Visual check:</p>
<div class="figure">
<img src="geocoder-paper_files/figure-html/unnamed-chunk-5-1.png" alt="Vancouver real estate dataset sample area from 'st_intersection' (left) and MongoDB 'geoIntersects' (right)." width="48%"><img src="geocoder-paper_files/figure-html/unnamed-chunk-5-2.png" alt="Vancouver real estate dataset sample area from 'st_intersection' (left) and MongoDB 'geoIntersects' (right)." width="48%"><p class="caption">
Vancouver real estate dataset sample area from ‘st_intersection’ (left) and MongoDB ‘geoIntersects’ (right).
</p>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-ameri2014application">
<p>Ameri, Parinaz, Udo Grabowski, Jörg Meyer, and Achim Streit. 2014. “On the Application and Performance of Mongodb for Climate Satellite Data.” In <em>2014 Ieee 13th International Conference on Trust, Security and Privacy in Computing and Communications</em>, 652–59. IEEE.</p>
</div>
<div id="ref-butler2016geojson">
<p>Butler, Howard, Martin Daly, Allan Doyle, Sean Gillies, Stefan Hagen, Tim Schaub, and others. 2016. “The Geojson Format.” <em>Internet Engineering Task Force (IETF)</em>.</p>
</div>
<div id="ref-goldberg2007text">
<p>Goldberg, Daniel W, John P Wilson, and Craig A Knoblock. 2007. “From Text to Geographic Coordinates: The Current State of Geocoding.” <em>URISA-WASHINGTON DC-</em> 19 (1). Citeseer: 33.</p>
</div>
<div id="ref-office2016open">
<p>National Statistics, Office for. 2016. “Open Geography Portal.”</p>
</div>
<div id="ref-page2015visualising">
<p>Page, Roderic. 2015. “Visualising Geophylogenies in Web Maps Using Geojson.” <em>PLoS Currents</em> 7. Public Library of Science.</p>
</div>
<div id="ref-pebesma2018simple">
<p>Pebesma, Edzer. 2018. “Simple Features for R: Standardized Support for Spatial Vector Data.” <em>The R Journal</em> 10 (1): 439–46.</p>
</div>
<div id="ref-tge">
<p>“Turing Geovisualization Engine.” 2019. <a href="https://www.turing.ac.uk/research/research-projects/turing-geovisualization-engine" class="uri">https://www.turing.ac.uk/research/research-projects/turing-geovisualization-engine</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#motivation">Motivation</a></li>
      <li><a href="#relevant-technology">Relevant technology</a></li>
      <li><a href="#uk-geocodes-case">UK geocodes case</a></li>
      <li><a href="#reproducible-example">Reproducible example</a></li>
      <li><a href="#r-vs-mongodb">R vs Mongodb</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by L Hama.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
